import*as t from"three";import*as e from"@babylonjs/havok";import{OrbitControls as s}from"three/examples/jsm/controls/OrbitControls.js";class n{constructor(t=!0){this.autoStart=t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}static now(){return("undefined"==typeof performance?Date:performance).now()}start(){this.startTime=n.now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const e=n.now();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return t}}var i;!function(t){t.startAnimate=function(t){const e="function"==typeof t?t:t.update.bind(t);let s=n.now();requestAnimationFrame((function t(i){let o=(i=i||n.now())-s;s=i,e(o),requestAnimationFrame(t)}))},t.startTimer=function(t,e){const s="function"==typeof t?t:t.update.bind(t);setInterval(s,e,e)}}(i||(i={}));var o,r=i;class h{[Symbol.iterator](){return this}next(){return{done:!0,value:void 0}}}class a{constructor(t){this.ops=[],this.core=t}pushOp(t,...e){this.ops.push([t,e])}flushOps(){const t=this.core;this.ops.forEach((([e,s])=>{(e=e.bind(t))(...s)})),this.ops=[]}update(t){this.flushOps()}}class c{}class d{constructor(t,e){this.world=t,this.id=e}body(){return this.world.getEntityBody(this.id)}dispose(){this.world.deleteEntity(this.id)}}class u{constructor(t,e){this.indx=t,this.comps=e}get(t){const e=this.indx.get(t);return this.comps[e]}has(...t){for(const e of t)if(!this.indx.has(e))return!1;return!0}}!function(t){t.demands=function(...t){return new Set(t)}}(o||(o={}));class m{constructor(...t){this.opQueue=new a(this),this.entities=new l,this.systems=t}createEntity(...t){this.opQueue.pushOp(this.createEntitySync,...t)}createEntitySync(...t){this.entities.newEntity(...t)}deleteEntity(t){this.opQueue.pushOp(this.deleteEntitySync,t)}deleteEntitySync(t){this.entities.deleteByID(t)}getEntityBody(t){return this.entities.getBodyByID(t)}update(t){const e=this.entities;this.systems.forEach((s=>{const n=new p(this,s.demands,e.iterateBatches());s.invoke(t,n)})),this.opQueue.update(t)}}class l{constructor(){this.batches=new Map,this.id2Batch=new Map,this.ids=function(){let t=1;return()=>t++}()}newEntity(...t){const e=this.getEntityBatch(...t.map((t=>t.constructor))),s=e.constructEntity(...t);return this.id2Batch.set(s,e),s}getEntityBatch(...t){t.sort();const e=t.toString();let s=this.batches.get(e);if(void 0!==s)return s;const n=new Map;for(let e=0;e<t.length;e++)n.set(t[e],e);return s=new y(n,this.ids),this.batches.set(e,s),s}deleteByID(t){const e=this.id2Batch.get(t);void 0!==e&&(this.id2Batch.delete(t),e.removeEntity(t))}getBodyByID(t){const e=this.id2Batch.get(t);if(void 0===e)return;const s=e.getEntity(t);return new u(e.componentIndex,s)}iterateBatches(){return this.batches.values()}}class y{constructor(t,e){this.entities=new Map,this.componentIndex=t,this.newID=e}constructEntity(...t){const e=this.newID();return t.sort(((t,e)=>this.componentIndex.get(t.constructor)-this.componentIndex.get(e.constructor))),this.entities.set(e,t),e}removeEntity(t){this.entities.delete(t)}getEntity(t){return this.entities.get(t)}matchDemands(t){for(const e of t)if(!this.componentIndex.has(e))return!1;return!0}[Symbol.iterator](){return this.entries()}entries(){return this.entities.entries()}}class p{constructor(t,e,s){this.currIndx=new Map,this.currIter=new h,this.demands=e,this.world=t,this.batches=s}next(){let t=this.currIter.next();if(t.done&&(this.nextBatch(),t=this.currIter.next()),t.done)return{done:!0,value:[]};const[e,s]=t.value;return{done:!1,value:[new d(this.world,e),new u(this.currIndx,s)]}}[Symbol.iterator](){return this}nextBatch(){for(;;){const t=this.batches.next();if(t.done)return this.currIndx=new Map,void(this.currIter=new h);const e=t.value;if(e.matchDemands(this.demands))return this.currIndx=e.componentIndex,void(this.currIter=e.entries())}}}class f extends c{constructor(t){super(),this.sys=t,this.body=t.hk.HP_Body_Create()[1],t.hk.HP_World_AddBody(t.world,this.body,!1),t.hk.HP_Body_SetMotionType(this.body,t.hk.MotionType.DYNAMIC)}getVelocity(){return this.sys.hk.HP_Body_GetLinearVelocity(this.body)[1]}setVelocity(t,e,s){this.sys.hk.HP_Body_SetLinearVelocity(this.body,[t,e,s])}getShape(){return this.sys.hk.HP_Body_GetShape(this.body)[1]}setShape(t){this.sys.hk.HP_Body_SetShape(this.body,t)}getQTransform(){return this.sys.hk.HP_Body_GetQTransform(this.body)[1]}setQTransform(t){this.sys.hk.HP_Body_SetQTransform(this.body,t)}getMatrix(){const e=this.sys.hk,s=this.sys.world,n=e.HP_World_GetBodyBuffer(s)[1],i=e.HP_Body_GetWorldTransformOffset(this.body)[1],o=new Float32Array(e.HEAPU8.buffer,n+i,16),r=new t.Matrix4;for(let t=0;t<15;t++)3!=(3&t)&&(r.elements[t]=o[t]);return r.elements[15]=1,r}}class w{constructor(t){this.demands=o.demands(),this.hk=t,this.world=t.HP_World_Create()[1],t.HP_World_SetGravity(this.world,[0,0,0])}invoke(t,e){this.hk.HP_World_Step(this.world,t)}}var x=function(t,e,s,n){return new(s||(s=Promise))((function(i,o){function r(t){try{a(n.next(t))}catch(t){o(t)}}function h(t){try{a(n.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,h)}a((n=n.apply(t,e||[])).next())}))};let v,g,B=Promise.resolve();B=B.then((()=>x(void 0,void 0,void 0,(function*(){return e.default().then((t=>{v=t,g=new w(t)}))}))));class S extends c{constructor(t){super(),this.mesh=t}}class _ extends c{constructor(t,e,s){super(),this.vx=0,this.vy=0,this.vz=0,this.x=t,this.y=e,this.z=s}}class b{constructor(){this.demands=o.demands(S,_)}invoke(t,e){for(const[t,s]of e){const t=s.get(S),e=s.get(_);t.mesh.position.set(e.x,e.y,e.z)}}}class E{constructor(){this.demands=o.demands(f,S)}invoke(t,e){for(const[t,s]of e){const t=s.get(f),e=s.get(S),[[n,i,o],[r,h,a,c]]=t.getQTransform();e.mesh.position.x=n,e.mesh.position.y=i,e.mesh.position.z=o,e.mesh.quaternion.x=r,e.mesh.quaternion.y=h,e.mesh.quaternion.z=a,e.mesh.quaternion.w=c}}}class T{constructor(){this.demands=o.demands(_)}invoke(t,e){t/=1e3;for(const[s,n]of e){const e=n.get(_);for(e.vx+=10*Math.random()-5,e.vy+=10*Math.random()-5,e.vz+=10*Math.random()-5,e.x+=e.vx*t;e.x<0;)e.x+=500;for(;e.x>=500;)e.x-=500;for(e.y+=e.vy*t;e.y<0;)e.y+=500;for(;e.y>=500;)e.y-=500;for(e.z+=e.vz*t;e.z<0;)e.z+=500;for(;e.z>=500;)e.z-=500}}}class I{constructor(){this.demands=o.demands(f)}invoke(t,e){for(const[t,s]of e){const t=s.get(f);let[[e,n,i],o]=t.getQTransform();for(;e<0;)e+=500;for(;e>=500;)e-=500;for(;n<0;)n+=500;for(;n>=500;)n-=500;for(;i<0;)i+=500;for(;i>=500;)i-=500;t.setQTransform([[e,n,i],o])}}}class M{constructor(e){this.canvas=e;const n=new t.PerspectiveCamera(45,e.width/e.height,.1,5e3);n.position.x=1e3,n.position.y=1e3,n.position.z=1e3,this.camera=n;const i=new t.Scene;this.scene=i;const o=new t.WebGLRenderer({canvas:e});o.setSize(e.width,e.height),this.renderer=o;const r=new s(this.camera,this.canvas);r.target=new t.Vector3(250,250,250),this.controls=r;const h=new m(new T,new b,g,new I,new E);this.world=h,this.initScene(),this.initAtoms()}initScene(){const e=new t.GridHelper(500,10);e.position.x=250,e.position.y=0,e.position.z=250,this.scene.add(e);const s=new t.AxesHelper(500);this.scene.add(s)}initAtoms(){const e=new t.Group;this.scene.add(e);const s=this.randomAtoms(500,"red");e.add(...s);for(const t of s){const e=new f(g),s=v.HP_Shape_CreateSphere([0,0,0],2)[1];e.setShape(s),e.setQTransform([[t.position.x,t.position.y,t.position.z],[t.quaternion.x,t.quaternion.y,t.quaternion.z,t.quaternion.w]]),e.setVelocity(100*Math.random()-50,100*Math.random()-50,100*Math.random()-50),this.world.createEntity(e,new S(t))}}randomAtoms(e,s){const n=new t.MeshBasicMaterial({color:s,side:t.DoubleSide}),i=new t.SphereGeometry(2,5,5),o=[];for(let s=0;s<e;s++){const e=new t.Mesh(i,n),s=400*Math.random()+50,r=400*Math.random()+50,h=400*Math.random()+50;e.position.set(s,r,h),e.scale.set(.5,.5,.5),o.push(e)}return o}execute(){const t=this.controls,e=this.renderer;r.startAnimate((s=>{t.update(s/1e3),e.render(this.scene,this.camera)})),r.startTimer(this.world,100)}}B=B.then((()=>{const t=document.getElementById("app");new M(t).execute()}));
