import*as t from"three";import e from"lil-gui";import{OrbitControls as s}from"three/examples/jsm/controls/OrbitControls.js";import i from"@dimforge/rapier3d-compat";class n{constructor(t=!0){this.autoStart=t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}static now(){return("undefined"==typeof performance?Date:performance).now()}start(){this.startTime=n.now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const e=n.now();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return t}}var o;!function(t){t.startAnimate=function(t){const e="function"==typeof t?t:t.update.bind(t);let s=n.now();requestAnimationFrame((function t(i){let o=(i=i||n.now())-s;s=i,e(o),requestAnimationFrame(t)}))},t.startTimer=function(t,e){const s="function"==typeof t?t:t.update.bind(t);setInterval(s,e,e)}}(o||(o={}));var r,a=o;class h{[Symbol.iterator](){return this}next(){return{done:!0,value:void 0}}}class c{constructor(t){this.ops=[],this.core=t}pushOp(t,...e){this.ops.push([t,e])}flushOps(){const t=this.core;this.ops.forEach((([e,s])=>{(e=e.bind(t))(...s)})),this.ops=[]}update(t){this.flushOps()}}class d{}class l{constructor(t,e){this.world=t,this.id=e}get body(){return this.world.getEntityBody(this.id)}dispose(){this.world.deleteEntity(this.id)}}class u{constructor(t,e){this.indx=t,this.comps=e}get(t){const e=this.indx.get(t);return this.comps[e]}has(...t){for(const e of t)if(!this.indx.has(e))return!1;return!0}}!function(t){t.demands=function(...t){return new Set(t)}}(r||(r={}));class m{constructor(...t){this.opQueue=new c(this),this.entities=new p,this.systems=t}createEntity(...t){this.opQueue.pushOp(this.createEntitySync,...t)}createEntitySync(...t){this.entities.newEntity(...t)}deleteEntity(t){this.opQueue.pushOp(this.deleteEntitySync,t)}deleteEntitySync(t){this.entities.deleteByID(t)}cleanEntities(){this.opQueue.pushOp(this.cleanEntitiesSync)}cleanEntitiesSync(){this.entities.cleanAll()}getEntityBody(t){return this.entities.getBodyByID(t)}update(t){this.opQueue.update(t);const e=this.entities;this.systems.forEach((s=>{const i=new g(this,s.demands,e.iterateBatches());s.invoke(t,i)}))}}class p{constructor(){this.batches=new Map,this.id2Batch=new Map,this.ids=function(){let t=1;return()=>t++}()}newEntity(...t){const e=this.getEntityBatch(...t.map((t=>t.constructor))),s=e.constructEntity(...t);return this.id2Batch.set(s,e),s}getEntityBatch(...t){t.sort();const e=t.toString();let s=this.batches.get(e);if(void 0!==s)return s;const i=new Map;for(let e=0;e<t.length;e++)i.set(t[e],e);return s=new y(i,this.ids),this.batches.set(e,s),s}cleanAll(){this.batches=new Map,this.id2Batch=new Map}deleteByID(t){const e=this.id2Batch.get(t);void 0!==e&&(this.id2Batch.delete(t),e.removeEntity(t))}getBodyByID(t){const e=this.id2Batch.get(t);if(void 0===e)return;const s=e.getEntity(t);return new u(e.componentIndex,s)}iterateBatches(){return this.batches.values()}}class y{constructor(t,e){this.entities=new Map,this.componentIndex=t,this.newID=e}constructEntity(...t){const e=this.newID();return t.sort(((t,e)=>this.componentIndex.get(t.constructor)-this.componentIndex.get(e.constructor))),this.entities.set(e,t),e}removeEntity(t){this.entities.delete(t)}getEntity(t){return this.entities.get(t)}matchDemands(t){for(const e of t)if(!this.componentIndex.has(e))return!1;return!0}[Symbol.iterator](){return this.entries()}entries(){return this.entities.entries()}}class g{constructor(t,e,s){this.currIndx=new Map,this.currIter=new h,this.demands=e,this.world=t,this.batches=s}next(){let t=this.currIter.next();if(t.done&&(this.nextBatch(),t=this.currIter.next()),t.done)return{done:!0,value:[]};const[e,s]=t.value;return{done:!1,value:[new l(this.world,e),new u(this.currIndx,s)]}}[Symbol.iterator](){return this}nextBatch(){for(;;){const t=this.batches.next();if(t.done)return this.currIndx=new Map,void(this.currIter=new h);const e=t.value;if(e.matchDemands(this.demands))return this.currIndx=e.componentIndex,void(this.currIter=e.entries())}}}const w=new DOMMatrixReadOnly([1,0,0,1,0,0]);class f{constructor(){this.currTrans=w,this.ID=f.nextID++}Update(t){}Draw(t){this.currTrans=t.getTransform()}RelativePoint(t){return this.calcPoint(t,this.currTrans.inverse())}AbsolutePoint(t){return this.calcPoint(t,this.currTrans)}calcPoint(t,e){let[s,i]=t;return[e.a*s+e.c*i+e.e,e.b*s+e.d*i+e.f]}}f.nextID=0;class v extends f{constructor(){super(),this.listeners=new Map}OnEvent(t,e){let s=this.listeners.get(t);void 0===s&&(s=[]),s.push(e),this.listeners.set(t,s)}FireEvent(t,...e){let s=this.listeners.get(t);void 0!==s&&s.forEach((s=>s.bind(this)(t,...e)))}}var M;!function(t){t.KeyPressed="KeyPressed",t.KeyReleased="KeyReleased",t.MousePressed="MousePressed",t.MouseReleased="MouseReleased",t.MouseMoved="MouseMoved",t.GotFocus="GotFocus",t.LostFocus="LostFocus"}(M||(M={}));class x{constructor(t){this.heartbeat=500,this.Main=t}WithHeartbeat(t){return this.heartbeat=t,this}Bind(t){this.registerUpdater(),this.registerDrawer(t),this.registerListener(t)}registerUpdater(){const t=this.Main;let e=Date.now();setInterval((()=>{let s=Date.now();t.Update(s-e),e=s}),this.heartbeat)}registerDrawer(t){const e=this.Main,s=()=>{t.clearRect(0,0,t.canvas.width,t.canvas.height),e.Draw(t),requestAnimationFrame(s)};requestAnimationFrame(s)}registerListener(t){if(!(this.Main instanceof v))return;const e=this.Main,s=t.canvas;s.addEventListener("keydown",(t=>{if(t.repeat)return;let s=t.key;e.FireEvent(M.KeyPressed,s)})),s.addEventListener("keyup",(t=>{let s=t.key;e.FireEvent(M.KeyReleased,s)})),s.addEventListener("mousedown",(t=>{let s=t.button-1,i=t.offsetX,n=t.offsetY;e.FireEvent(M.MousePressed,s,[i,n])})),s.addEventListener("mouseup",(t=>{let s=t.button-1,i=t.offsetX,n=t.offsetY;e.FireEvent(M.MouseReleased,s,[i,n])})),s.addEventListener("mousemove",(t=>{let s=t.offsetX,i=t.offsetY;e.FireEvent(M.MouseMoved,[s,i])}))}}class b{constructor(t){this.ctx=t}get Width(){return this.ctx.canvas.width}get Height(){return this.ctx.canvas.height}}class E{static FromContext(t){return new E(new b(t))}constructor(t){this.shape=t}Put(t,...e){}CalcWidth(t){return this.shape.Width}CalcHeight(t){return this.shape.Height}CalcX(t){return 0}CalcY(t){return 0}}class k extends v{constructor(t){super(),this.focusing=!1,this.coordinator=t}get Width(){return this.coordinator.CalcWidth(this)}get Height(){return this.coordinator.CalcHeight(this)}get X(){return this.coordinator.CalcX(this)}get Y(){return this.coordinator.CalcY(this)}get Focusing(){return this.focusing}set Focusing(t){this.focusing!=t&&(this.focusing=t,this.FireEvent(t?M.GotFocus:M.LostFocus))}}class S extends d{constructor(t,e){super(),this.sys=t,this.body=t.world.createRigidBody(t.rapier.RigidBodyDesc.dynamic().setLinearDamping(0).setAngularDamping(0)),this.sys.world.createCollider(e,this.body)}get lVelocity(){const t=this.body.linvel();return[t.x,t.y,t.z]}set lVelocity(t){const[e,s,i]=t;this.body.setLinvel({x:e,y:s,z:i},!0)}get aVelocity(){const t=this.body.angvel();return[t.x,t.y,t.z]}set aVelocity(t){const[e,s,i]=t;this.body.setAngvel({x:e,y:s,z:i},!0)}get qTransform(){const t=this.body.translation(),e=this.body.rotation();return[[t.x,t.y,t.z],[e.x,e.y,e.z,e.w]]}set qTransform(t){const[e,s]=t;{const[t,s,i]=e;this.body.setTranslation({x:t,y:s,z:i},!0)}{const[t,e,i,n]=s;this.body.setRotation({x:t,y:e,z:i,w:n},!0)}}}class T{constructor(t){this.demands=r.demands(),this.rapier=t,this.world=new t.World({x:0,y:0,z:0})}invoke(t,e){this.world.timestep=t/1e3,this.world.step()}}var B=function(t,e,s,i){return new(s||(s=Promise))((function(n,o){function r(t){try{h(i.next(t))}catch(t){o(t)}}function a(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,a)}h((i=i.apply(t,e||[])).next())}))};let I,D=Promise.resolve();class P extends T{}class F extends S{}D=D.then((()=>B(void 0,void 0,void 0,(function*(){return i.init().then((()=>{I=new P(i)}))}))));const R=200,q=600;function z(t){const e=1500,s=700/1593.78,i=.0291*Math.exp(-s*s/2);return e-1e3*Math.exp(-i*(t-120))}const H=Math.min(z(R),z(q)),C=Math.max(z(R),z(q)),V=new Map,A=20;function W(t){if(t===R)return 1;let e=V.get(t);if(void 0!==e)return e;const s=W(t-A),i=z(t)/20;return e=s*Math.exp(-A/i),V.set(t,e),e}function G(t){const e=t-(t-R)%A,s=W(e),i=z(t)/20;return s*Math.exp(-(t-e)/i)}const L=Math.min(G(q),G(R)),O=Math.max(G(q),G(R)),U=500,X=750,Y=500;function K(t){const[e,s,i]=t;return e<0||e>U||s<0||s>X||i<0||i>Y}class Q extends d{constructor(t){super(),this.mesh=t}}class j extends d{constructor(){super(...arguments),this.mark=!1}}class Z{constructor(){this.demands=r.demands(F,j,Q)}invoke(t,e){for(const[t,s]of e){const t=s.get(Q),e=s.get(F),[[i,n,o],[r,a,h,c]]=e.qTransform;t.mesh.position.x=i,t.mesh.position.y=n,t.mesh.position.z=o,t.mesh.quaternion.x=r,t.mesh.quaternion.y=a,t.mesh.quaternion.z=h,t.mesh.quaternion.w=c,t.mesh.visible=!K([i,n,o]);const d=s.get(j);t.mesh.material=d.mark?tt:_}}}class ${constructor(){this.demands=r.demands(F)}invoke(t,e){for(const[t,s]of e){const t=s.get(F),[[e,i,n],o]=t.qTransform;let[r,a,h]=t.lVelocity;(e<-50&&r<0||e>550&&r>0)&&(r=-r),(i<-50&&a<0||i>800&&a>0)&&(a=-a),(n<-50&&h<0||n>550&&h>0)&&(h=-h),t.lVelocity=[r,a,h]}}}class J{constructor(){this.demands=r.demands(F)}setView(t){this.view=t}invoke(t,e){if(void 0===this.view)return;let s=0,i=0;for(const[t,n]of e){const t=n.get(F),[e,o,r]=t.lVelocity;s+=Math.sqrt(e*e+o*o+r*r),i++}const n=0===i?0:s/i;var o;this.view.kelvin=(o=n)*o/10}}class N{constructor(){this.demands=r.demands(F,j)}setVelocity(t){this.velocity=t}invoke(t,e){let s,i,n=0;for(const[t,o]of e){const e=o.get(j),[[r,a,h],c]=o.get(F).qTransform;if(e.mark)s=t,K([r,a,h])&&(e.mark=!1,s=void 0);else if(K([r,a,h]));else{const e=this.distance([r,a,h],[250,0,250]);(void 0===i||e<n)&&(i=t,n=e)}}if(void 0===s&&void 0!==i){s=i;s.body.get(j).mark=!0}if(void 0!==this.velocity&&void 0!==s){s.body.get(F).lVelocity=this.velocity,this.velocity=void 0}}distance(t,e){const[s,i,n]=t,[o,r,a]=e,h=s-o,c=i-r,d=n-a;return Math.sqrt(h*h+c*c+d*d)}}const _=new t.MeshBasicMaterial({color:"grey",side:t.DoubleSide}),tt=new t.MeshBasicMaterial({color:"red",side:t.DoubleSide}),et=new t.SphereGeometry(10,5,5);class st{constructor(e){this.sysMark=new N,this.sysSum=new J,this.sysPhy=e,this.scene=new t.Scene,this.group=new t.Group,this.initScene(),this.world=new m(this.sysMark,this.sysPhy,this.sysSum,new $,new Z)}initScene(){const e=new t.GridHelper(500,10);e.position.x=250,e.position.y=X,e.position.z=250,this.scene.add(e);const s=new t.GridHelper(500,10);s.position.x=250,s.position.y=0,s.position.z=250,this.scene.add(s);const i=new t.MeshBasicMaterial({color:"white",transparent:!0,opacity:.1,side:t.DoubleSide}),n=new t.MeshBasicMaterial({transparent:!0,opacity:0}),o=new t.Mesh(new t.BoxGeometry(U,X,Y),[i,i,n,n,i,i]);o.position.x=250,o.position.y=375,o.position.z=250,this.scene.add(o);const r=new t.BoxHelper(o,"white");this.scene.add(r),this.scene.add(this.group)}setView(t){this.sysSum.setView(t)}setMarkVelocity(t,e,s){this.sysMark.setVelocity([t,e,s])}cleanAtoms(){this.scene.remove(this.group),this.group=new t.Group,this.scene.add(this.group);const e=this.sysPhy.world;e.forEachRigidBody((t=>{e.removeRigidBody(t)})),this.world.cleanEntities()}randomAtoms(t,e){const s=30,i=16.666666666666668,n=16.666666666666668,o=new Map;t=Math.min(t,6944.444444444445);for(let r=0;r<t;r++){let[t,r,a]=this.randomSlot(o,[i,25,n]);t=(t+.5)*s,r=(r+.5)*s,a=(a+.5)*s;const h=this.randomVel(e);this.addAtom([t,r,a],h)}}randomSlot(t,e){let s;do{s=[Math.floor(Math.random()*e[0]),Math.floor(Math.random()*e[1]),Math.floor(Math.random()*e[2])]}while(t.has(s.toString()));return t.set(s.toString(),!0),s}randomVel(t){const e=Math.random()*Math.PI,s=Math.cos(e)*t,i=Math.sin(e)*t,n=Math.random()*Math.PI*2,o=Math.cos(n)*i;return[Math.sin(n)*i,o,s]}addAtom(e,s){const n=new t.Mesh(et);n.position.set(e[0],e[1],e[2]),n.scale.set(.5,.5,.5),this.group.add(n);const o=i.ColliderDesc.ball(10).setRestitution(1).setFriction(0),r=this.newPhysicsComponent(o);r.qTransform=[[n.position.x,n.position.y,n.position.z],[n.quaternion.x,n.quaternion.y,n.quaternion.z,n.quaternion.w]],r.lVelocity=s,this.world.createEntity(r,new Q(n),new j)}newPhysicsComponent(t){return new F(this.sysPhy,t)}}class it{constructor(i,n){this.left=i,this.right=n;const o=new t.PerspectiveCamera(45,n.width/n.height,.1,5e3);o.position.x=1e3,o.position.y=1e3,o.position.z=1e3,this.camera=o;const r=new t.WebGLRenderer({canvas:n});r.setSize(n.width,n.height),this.renderer=r;const a=new s(this.camera,this.right);a.target=new t.Vector3(250,375,250),this.controls=a;const h=new st(I);this.game=h;const c=new e;this.gui=c}execute(){this.initGUI();const t=this.controls,e=this.renderer;a.startAnimate((s=>{t.update(s/1e3),e.render(this.game.scene,this.camera)})),a.startTimer(this.game.world,1/60*1e3)}newGUIData(){const t=this.game,e={kelvin:0,parameters:{kelvin:500,atoms:250,reset:()=>{var s;t.cleanAtoms(),t.randomAtoms(e.parameters.atoms,(s=e.parameters.kelvin,Math.sqrt(10*s)))}},marked:{vx:0,vy:0,vz:0,fire:()=>{t.setMarkVelocity(e.marked.vy,e.marked.vz,e.marked.vx)}}};return t.setView(e),e}initGUI(){const t=this.newGUIData(),e=this.left.getContext("2d"),s=new nt(E.FromContext(e),t.parameters);new x(s).Bind(e),t.parameters.reset(),this.gui.title("控制"),this.gui.open().add(t,"kelvin").decimals(2).name("当前温度").disable().listen();const i=this.gui.addFolder("环境参数").open();i.add(t.parameters,"kelvin",0,1e3,10).name("温度").listen(),i.add(t.parameters,"atoms",0,500,10).name("数密度").listen(),i.add(t.parameters,"reset").name("重置");const n=this.gui.addFolder("追踪粒子").open();n.add(t.marked,"vx",-50,50,1).name("速度X"),n.add(t.marked,"vy",-50,50,1).name("速度Y"),n.add(t.marked,"vz",-50,50,1).name("速度Z"),n.add(t.marked,"fire").name("设置")}}class nt extends k{constructor(t,e){super(t),this.h=this.Height/2,this.pressing=!1,this.params=e,this.OnEvent(M.MouseMoved,this.onMouseMoved),this.OnEvent(M.MousePressed,this.onMousePressed),this.OnEvent(M.MouseReleased,this.onMouseReleased)}Draw(t){super.Draw(t);const e=t.createLinearGradient(0,this.Height,0,0);e.addColorStop(1,"rgb(0 0 0)"),e.addColorStop(.5,"rgb(0 0 0)"),e.addColorStop(0,"rgb(0 0 100)"),t.fillStyle=e,t.fillRect(0,0,this.Width,this.Height),t.beginPath(),this.drawFunction(t,z,H,C),t.lineWidth=3,t.strokeStyle="orange",t.stroke(),t.beginPath(),this.drawFunction(t,G,L,O),t.lineWidth=3,t.strokeStyle="grey",t.stroke(),t.beginPath(),t.moveTo(0,this.h),t.lineTo(this.Width,this.h),t.lineTo(this.Width-4,this.h-3),t.lineTo(this.Width-4,this.h+3),t.lineTo(this.Width,this.h),t.lineWidth=2,t.strokeStyle="red",t.stroke(),t.fillStyle="red";const s=(q-R)/this.Height*(this.Height-this.h)+R;t.fillText(`height: ${s.toFixed(3)}km`,2,this.h-2)}drawFunction(t,e,s,i){const n=this.Height,o=q-R,r=this.Width,a=i-s,h=t=>r/a*(e(t=o/n*(n-t)+R)-s);t.moveTo(h(0),0);for(let e=1;e<=100;e++){const s=e/100*n,i=h(s);t.lineTo(i,s)}}updateHeight(t){this.h=t,t=(q-R)/this.Height*(this.Height-t)+R,this.params.atoms=500*G(t),this.params.kelvin=z(t)}onMousePressed(t,e,s){if(e>=0)return;this.pressing=!0;let[i,n]=this.RelativePoint(s);this.updateHeight(n)}onMouseReleased(t,e,s){if(e>=0)return;this.pressing=!1;let[i,n]=this.RelativePoint(s);this.updateHeight(n)}onMouseMoved(t,e){if(!this.pressing)return;let[s,i]=this.RelativePoint(e);this.updateHeight(i)}}D=D.then((()=>{const t=document.getElementById("left-panel"),e=document.getElementById("right-panel");new it(t,e).execute()}));
